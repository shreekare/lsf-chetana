<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen text-xl">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100 mx-auto w-full"
         style="max-width: 95vw; min-height: 95vh;">

        <!-- HEADER ROW: Logo (Left) and Title (Right & vertically centered) -->
        <div class="flex justify-between items-center mb-6">
            <!-- Logo (Left) -->
            <div class="flex-shrink-0 mr-6"> 
                <img src="https://drive.google.com/thumbnail?id=1FArQtL7K40Tyc-gU7UD-yjMw7GlwTumt" 
                     alt="Chetana Tracker Logo" 
                     style="height: 150px; max-width: 100%;" 
                     class="block" 
                     onerror="this.onerror=null; this.src='https://placehold.co/150x150/f0f9ff/000000?text=Logo+Unavailable'">
            </div>

            <!-- Title and Description (Right Horizontally and Center Vertically) -->
            <div class="flex-1 min-w-0 text-right">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Chetana Session Tracker</h1>
                <p class="text-gray-600">Fill out this form for each session separately.</p>
            </div>
        </div>

        <div id="statusMessage" class="mt-4 p-4 rounded-lg text-lg hidden"></div>

        <form id="submissionForm" class="space-y-6">

            <div>
                <label for="name" class="block font-medium text-gray-700 mb-1">Your Name</label>
                <select id="name" name="name" required
                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <option value="" disabled selected>Select your name</option>
                    </select>
            </div>

            <div>
                <label for="sessionStartTime" class="block font-medium text-gray-700 mb-1">Date and Session Start Time</label>
                <input type="datetime-local" id="sessionStartTime" name="sessionStartTime" required
                       class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            </div>

            <div>
                <label for="sessionEndTime" class="block font-medium text-gray-700 mb-1">Session End Time</label>
                <input type="datetime-local" id="sessionEndTime" name="sessionEndTime" required
                       class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            </div>

            <div>
                <label for="module" class="block font-medium text-gray-700 mb-1">Module/Topic</label>
                <select id="module" name="module" required
                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <option value="" disabled selected>Select module</option>
                    </select>
            </div>

            <div class="border-t pt-6 mt-6">
                <label for="schoolName" class="block font-medium text-gray-700 mb-1">School Name</label>
                <select id="schoolName" name="schoolName" required
                        onchange="populateClassInputs()"
                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <option value="" disabled selected>Select School</option>
                    </select>
            </div>

            <div id="classInputsContainer" class="space-y-4">
                <p class="text-gray-500">Please select a school to enter number of students attended the session.</p>
            </div>

            <div class="border-t pt-6 mt-6">
                <label for="learningOutcomes" class="block font-medium text-gray-700 mb-1">Learning Outcomes Observed</label>
                <textarea id="learningOutcomes" name="learningOutcomes" rows="4" required
                          class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                          placeholder="What learning outcomes did you observe?"></textarea>
            </div>

            <div>
                <label for="challengesFaced" class="block font-medium text-gray-700 mb-1">Challenges Faced</label>
                <textarea id="challengesFaced" name="challengesFaced" rows="4" required
                          class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                          placeholder="What challenges, if any, did you face?"></textarea>
            </div>


            <button type="submit" id="submitButton"
                    class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 disabled:opacity-50">
                Submit Session Data
            </button>
        </form>
    </div>

    <script>
        // CLIENT-SIDE JAVASCRIPT
        const statusMessage = document.getElementById('statusMessage');
        const submissionForm = document.getElementById('submissionForm');
        const submitButton = document.getElementById('submitButton');
        const schoolSelect = document.getElementById('schoolName');
        const classInputsContainer = document.getElementById('classInputsContainer');
        const startTimeInput = document.getElementById('sessionStartTime');
        const endTimeInput = document.getElementById('sessionEndTime');

        // --- DATA INJECTION FROM SERVER (FIXED with try...catch) ---
        const ALL_DATA = (() => {
            try {
                return JSON.parse('<?!= formData ?>');
            } catch (e) {
                console.error("Error loading dynamic data.", e);
                showMessage('ERROR: Dynamic school data failed to load. Please ensure the Apps Script is correctly deployed.', 'bg-red-100 text-red-800');
                return {
                    schoolData: { error: "Dynamic data loading failed." },
                    coordinatorData: { error: "Dynamic data loading failed." },
                    moduleData: { error: "Dynamic data loading failed." }
                };
            }
        })();

        // Destructure the data for easier access
        const SCHOOL_DATA = ALL_DATA.schoolData || { error: "School data missing." };
        const COORDINATOR_DATA = ALL_DATA.coordinatorData || { error: "Coordinator data missing." };
        const MODULE_DATA = ALL_DATA.moduleData || { error: "Module data missing." };

        const SCHOOL_NAMES = Object.keys(SCHOOL_DATA).filter(key => key !== 'error');

        /**
         * Populates the School Name dropdown on page load.
         */
        function populateSchoolDropdown() {
            if (SCHOOL_DATA.error) {
                showMessage('ERROR (Schools): ' + SCHOOL_DATA.error, 'bg-red-100 text-red-800');
            } else if (SCHOOL_NAMES.length === 0) {
                showMessage('ERROR: No school data found. Check the "Schools" sheet.', 'bg-red-100 text-red-800');
            } else {
                const schoolOptions = SCHOOL_NAMES.map(name => `<option value="${name}">${name}</option>`).join('');
                schoolSelect.innerHTML += schoolOptions;
            }
        }

        /**
         * NEW: Populates the Coordinator Name dropdown on page load.
         */
        function populateCoordinatorDropdown() {
            const nameSelect = document.getElementById('name');
            if (COORDINATOR_DATA.error) {
                showMessage('ERROR (Coordinators): ' + COORDINATOR_DATA.error, 'bg-red-100 text-red-800');
            } else {
                const coordinatorOptions = COORDINATOR_DATA.data
                    .map(name => `<option value="${name}">${name}</option>`)
                    .join('');
                nameSelect.innerHTML += coordinatorOptions;
            }
        }

        /**
         * NEW: Populates the Module dropdown on page load.
         */
        function populateModuleDropdown() {
            const moduleSelect = document.getElementById('module');
            if (MODULE_DATA.error) {
                showMessage('ERROR (Modules): ' + MODULE_DATA.error, 'bg-red-100 text-red-800');
            } else {
                const moduleOptions = MODULE_DATA.data
                    .map(name => `<option value="${name}">${name}</option>`)
                    .join('');
                moduleSelect.innerHTML += moduleOptions;
            }
        }

        /**
         * Populates the class container with number inputs based on selected school.
         */
        function populateClassInputs() {
            const selectedSchool = schoolSelect.value;
            classInputsContainer.innerHTML = ''; // Clear previous inputs

            if (selectedSchool && SCHOOL_DATA[selectedSchool]) {
                const availableClasses = SCHOOL_DATA[selectedSchool];
                let html = `<h3 class="text-2xl font-semibold text-gray-700 mb-4">Student Counts for ${selectedSchool}</h3>`;

                // Create a grid for the inputs
                html += '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">';

                availableClasses.forEach(cls => {
                    html += `
                        <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                            <label for="class_${cls}" class="block font-medium text-gray-700">${cls}</label>
                            <input type="number" id="class_${cls}"
                                   data-class-name="${cls}"
                                   name="class_count_${cls}"
                                   min="0" max="100"
                                   placeholder="0"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    `;
                });

                html += '</div>';
                classInputsContainer.innerHTML = html;
            } else {
                classInputsContainer.innerHTML = '<p class="text-gray-500">Please select a school to see class inputs.</p>';
            }
        }


        // --- Submission Logic ---
        submissionForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // --- 1. VALIDATION ---

            // A. Time Validation
            const startTimeInputVal = startTimeInput.value;
            const endTimeInputVal = endTimeInput.value;

            if (!startTimeInputVal || !endTimeInputVal) {
                showMessage('Please enter both a start and end time.', 'bg-yellow-100 text-yellow-800');
                return;
            }

            const startTime = new Date(startTimeInputVal);
            const endTime = new Date(endTimeInputVal);
            const durationInMinutes = (endTime.getTime() - startTime.getTime()) / 60000;

            if (endTime <= startTime) {
                showMessage('Session End Time must be after the Session Start Time.', 'bg-red-100 text-red-800');
                return;
            }

            // 1 hour = 60 minutes. 3 hours = 180 minutes.
            if (durationInMinutes < 60 || durationInMinutes > 180) {
                 showMessage('Session duration must be between 1 and 3 hours.', 'bg-red-100 text-red-800');
                 return;
            }

            // B. Student Count Validation
            const classInputs = classInputsContainer.querySelectorAll('input[type="number"]');
            let classCountsArray = [];
            let totalStudents = 0;

            classInputs.forEach(input => {
                const className = input.dataset.className;
                const count = parseInt(input.value || 0);

                if (count > 0) {
                    classCountsArray.push(`${className}: ${count}`);
                    totalStudents += count;
                }
            });

            // Total students must be between 5 and 100
            if (totalStudents < 5 || totalStudents > 100) {
                 showMessage(`Total student count must be between 5 and 100. (Current total: ${totalStudents})`, 'bg-red-100 text-red-800');
                 return;
            }

            // --- 2. PREPARE DATA ---
            const formData = {
                name: document.getElementById('name').value,
                sessionStartTime: startTimeInputVal,
                sessionEndTime: endTimeInputVal,
                module: document.getElementById('module').value,
                schoolName: document.getElementById('schoolName').value,
                classCounts: classCountsArray.join(', '), // Format as "6a: 15, 7b: 20"
                learningOutcomes: document.getElementById('learningOutcomes').value,
                challengesFaced: document.getElementById('challengesFaced').value
            };

            // --- 3. SUBMIT ---
            submitButton.textContent = 'Submitting...';
            submitButton.disabled = true;
            showMessage('Saving your data... please wait.', 'bg-blue-100 text-blue-800');

            // Call the server-side Apps Script function
            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(onError)
                .processForm(formData);
        });

        function showMessage(text, className) {
            statusMessage.className = `mt-4 p-4 rounded-lg block ${className}`;
            statusMessage.textContent = text;
        }

        // Callback function for successful server execution
        function onSuccess(result) {
            submitButton.textContent = 'Submit Session Data';
            submitButton.disabled = false;

            // Reset the form
            submissionForm.reset();
            // Clear the dynamic class inputs
            classInputsContainer.innerHTML = '<p class="text-gray-500">Please select a school to see class inputs.</p>';

            showMessage('Success! Data has been saved to the Google Sheet.', 'bg-green-100 text-green-800');
        }

        // Callback function for failed server execution
        function onError(error) {
            submitButton.textContent = 'Submit Session Data';
            submitButton.disabled = false;
            showMessage('Error: Failed to save data. ' + error.message, 'bg-red-100 text-red-800');
            console.error(error);
        }

        /**
         * Helper function to format a Date object into a datetime-local string (YYYY-MM-DDTHH:MM).
         * @param {Date} date The date object to format.
         * @return {string} The formatted string.
         */
        function formatDateTimeLocal(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d}T${h}:${min}`;
        }

        /**
         * Sets the default start time to today at 9:00 AM if the field is empty on focus.
         */
        startTimeInput.addEventListener('focus', function() {
            if (!this.value) {
                const now = new Date();
                // Today, 9:00 AM
                const defaultTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0);
                this.value = formatDateTimeLocal(defaultTime);
            }
        });

        /**
         * Sets the default end time to 90 minutes after the start time if the field is empty on focus.
         */
        endTimeInput.addEventListener('focus', function() {
            if (!this.value && startTimeInput.value) {
                const startTime = new Date(startTimeInput.value);
                // Add 90 minutes (1.5 hours)
                const defaultEndTime = new Date(startTime.getTime() + 90 * 60000);
                this.value = formatDateTimeLocal(defaultEndTime);
            }
        });

        // --- Initialize Page ---
        // Populate all dynamic dropdowns when the script loads
        populateSchoolDropdown();
        populateCoordinatorDropdown();
        populateModuleDropdown();
    </script>
</body>
</html>
