<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chetana Tracker Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ---------------------------------- */
        /* BASE & LAYOUT STYLES */
        /* ---------------------------------- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* bg-gray-50 */
            padding: 1rem;
            min-height: 100vh;
            text-align: left;
        }

        @media (min-width: 780px) {
            body { padding: 2rem; }
        }

        .container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            border: 1px solid #f3f4f6; /* border-gray-100 */
            margin: 2rem auto;
            width: 100%;
            max-width: 1280px; /* max-w-7xl */
            font-size: 1rem;
        }

        /* ---------------------------------- */
        /* HEADER STYLES */
        /* ---------------------------------- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .logo-container {
            flex-shrink: 0;
            margin-right: 1.5rem;
        }
        .header-title-container {
            flex: 1 1 0%;
            min-width: 0;
            text-align: right;
        }
        .header-title {
            font-size: 1.875rem;
            font-weight: 700; /* font-bold */
            color: #1f2937; /* text-gray-800 */
            margin-bottom: 0.5rem;
        }
        .header-subtitle {
            color: #4b5563; /* text-gray-600 */
            font-size: 1rem;
        }

        /* ---------------------------------- */
        /* FILTER FORM STYLES */
        /* ---------------------------------- */
        .filter-section {
            background-color: #f9fafb; /* bg-gray-50 */
            padding: 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.05); /* shadow-inner */
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb; /* border border-gray-200 */
        }

        .filter-section h2 {
            font-size: 1.25rem;
            font-weight: 600; /* font-semibold */
            color: #374151; /* text-gray-700 */
            margin-bottom: 1rem;
        }

        .filter-grid-row-1 {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
            align-items: flex-end; /* items-end */
            margin-bottom: 1rem;
        }
        @media (min-width: 768px) {
            .filter-grid-row-1 {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-700 */
        }

        .input-field, .select-field {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            font-size: 1rem;
        }
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* focus:ring-blue-500 */
        }

        #filterStartDate, #filterEndDate {
          width: 90%;
        }

        /* Quick Range Buttons Row (Row 2) */
        .filter-grid-row-2 {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
            padding-top: 0.5rem;
        }
        @media (min-width: 768px) {
            .filter-grid-row-2 {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .quick-range-container {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: white; /* bg-white */
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.05); /* shadow-inner */
            align-items: center;
        }
        .quick-range-container span {
            font-size: 0.875rem;
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-700 */
            margin-right: 0.25rem;
            flex-shrink: 0;
        }

        .quick-range-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            line-height: 1rem;
            font-weight: 600; /* font-semibold */
            border-radius: 0.5rem;
            border: 1px solid #60a5fa; /* border-blue-400 */
            color: #1e40af; /* text-blue-800 */
            background-color: #dbeafe; /* bg-blue-100 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: background-color 150ms ease-in-out;
            cursor: pointer;
        }
        .quick-range-btn:hover {
            background-color: #bfdbfe; /* hover:bg-blue-200 */
        }

        /* Style for Clear Dates button */
        .quick-range-btn[data-range="clear"] {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
            border-color: #d1d5db; /* border-gray-300 */
        }
        .quick-range-btn[data-range="clear"]:hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }

        /* Submit Button */
        #filterButton {
            width: 100%;
            padding: 0.5rem 1.5rem;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* shadow-lg */
            font-weight: 500;
            color: white;
            background-color: #10b981; /* bg-green-600 */
            transition: background-color 0.3s;
            cursor: pointer;
        }
        @media (min-width: 768px) {
            #filterButton {
                width: auto; /* md:w-auto */
            }
        }
        #filterButton:hover {
            background-color: #059669; /* hover:bg-green-700 */
        }
        #filterButton:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5); /* focus:ring-green-500 */
        }
        #filterButton:disabled {
            opacity: 0.5; /* disabled:opacity-50 */
            cursor: not-allowed;
        }

        /* ---------------------------------- */
        /* REPORT DISPLAY STYLES */
        /* ---------------------------------- */
        #reportContainer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .report-section-title {
            font-size: 1.5rem;
            font-weight: 700; /* font-bold */
            color: #1f2937; /* text-gray-800 */
            border-bottom: 2px solid #e5e7eb; /* border-b*/
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Filter Info Box */
        .filter-info-box {
            padding: 0.75rem; /* p-3 */
            background-color: #eff6ff; /* bg-indigo-50 */
            border-radius: 0.375rem; /* rounded-md */
            color: #1e40af; /* text-indigo-800 */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 1.5rem;
        }
        .filter-info-box strong {
            font-weight: 700;
        }

        /* Table Styling */
        .table-wrapper {
            overflow-x: auto;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow-md */
            margin-bottom: 1.5rem;
        }

        .data-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table thead {
            background-color: #f3f4f6; /* bg-gray-200 */
        }
        .data-table th {
            padding: 0.75rem 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563; /* text-gray-600 */
            text-transform: uppercase;
        }

        .data-table tbody tr {
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table tbody tr:hover {
            background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        .data-table td {
            padding: 0.5rem 0.75rem;
            white-space: nowrap; /* whitespace-nowrap */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
        }
        .data-table td:nth-child(1) { /* S No */
            text-align: center;
            color: #1f2937;
        }

        /* Class Breakdown (Report 2) */
        .class-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .class-breakdown-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .class-card {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .class-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1d4ed8; /* text-blue-700 */
            margin-bottom: 0.75rem;
        }
        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        .breakdown-table tbody tr {
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }
        .breakdown-table tbody tr:hover {
            background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        .breakdown-table thead {
            background-color: #eff6ff;
        }
        .breakdown-table th {
            padding: 0.75rem 0.75rem;
            background-color: #eff6ff;
            text-align: center;
            color: #1e40af; /* text-blue-800 */
            font-weight: 600;
            text-transform: uppercase;
        }
        .breakdown-table td {
            padding: 0.4rem;
            border: 1px solid #f3f4f6;
            font-weight: 400;
            text-align: center;
        }
        .breakdown-table td:nth-child(2) { /* Module */
            text-align: left;
        }

        /* ---------------------------------- */
        /* STATUS MESSAGE STYLES */
        /* ---------------------------------- */
        #statusMessage {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            display: none;
            text-align: center;
        }
        .status-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-red {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://drive.google.com/thumbnail?id=1FArQtL7K40Tyc-gU7UD-yjMw7GlwTumt"
                     alt="Chetana Tracker Logo"
                     style="height: 150px; max-width: 100%;"
                     onerror="this.onerror=null; this.src='https://placehold.co/600x100/fcb116/ffffff?font=montserrat&text=Learning+Space+Foundation'">
            </div>

            <div class="header-title-container">
                <h1 class="header-title">Chetana Tracker Dashboard</h1>
                <p class="header-subtitle">Filter the session data and view reports.</p>
            </div>
        </div>

        <div class="filter-section">
            <h2>Filter Sessions</h2>
            <form id="filterForm">

                <div class="filter-grid-row-1">

                    <div>
                        <label for="filterName">Coordinator</label>
                        <select id="filterName" name="name" class="select-field"></select>
                    </div>

                    <div>
                        <label for="filterSchool">School</label>
                        <select id="filterSchool" name="school" class="select-field"></select>
                    </div>

                    <div>
                        <label for="filterStartDate">Start Date (Optional)</label>
                        <input type="date" id="filterStartDate" name="startDate" class="input-field">
                    </div>

                    <div>
                        <label for="filterEndDate">End Date (Optional)</label>
                        <input type="date" id="filterEndDate" name="endDate" class="input-field">
                    </div>

                    <div class="hidden md:block"></div>
                </div>

                <div class="filter-grid-row-2">
                    <div class="quick-range-container">
                        <span>Quick Date Ranges:</span>
                        <button type="button" class="quick-range-btn" data-range="thisWeek">This Week</button>
                        <button type="button" class="quick-range-btn" data-range="lastWeek">Last Week</button>
                        <button type="button" class="quick-range-btn" data-range="thisMonth">This Month</button>
                        <button type="button" class="quick-range-btn" data-range="lastMonth">Last Month</button>
                        <button type="button" class="quick-range-btn" data-range="clear">Clear Dates</button>
                    </div>

                    <button type="submit" id="filterButton">
                        Run Report
                    </button>
                </div>
            </form>
        </div>
        <div id="statusMessage"></div>

        <div id="reportContainer">
            <p>Use the filters above and click <b>Run Report</b> to display session data.</p>
        </div>
    </div>

    <script>
        const filterForm = document.getElementById('filterForm');
        const reportContainer = document.getElementById('reportContainer');
        const filterButton = document.getElementById('filterButton');
        const statusMessage = document.getElementById('statusMessage');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const quickRangeButtons = document.querySelectorAll('.quick-range-btn');

        /**
         * Shows a status message.
         * @param {string} text The message text.
         * @param {string} className The status class (e.g., 'status-red').
         */
        function showMessage(text, className) {
            statusMessage.className = `${className}`;
            statusMessage.textContent = text;
            statusMessage.style.display = 'block';
            statusMessage.scrollIntoView({ behavior: 'smooth' });
        }

        // --- Data Injection from Server ---
        const FILTER_DATA = (() => {
            try {
                // IMPORTANT: Template variable name must match the one in Apps Script (filterData)
                return JSON.parse('<?!= filterData ?>');
            } catch (e) {
                console.error("Error loading filter data.", e);
                showMessage('ERROR: Dynamic data failed to load.', 'status-red');
                return { coordinators: [], schools: [], modules: [] };
            }
        })();

        // --- Date Range Helpers ---

        /**
         * Formats a Date object to a YYYY-MM-DD string for input type="date".
         * @param {Date} date
         * @returns {string}
         */
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        /**
         * Calculates start and end dates for predefined ranges.
         * @param {string} rangeType - 'thisWeek', 'lastWeek', 'thisMonth', 'lastMonth'.
         * @returns {{start: string, end: string} | null}
         */
        function getRangeDates(rangeType) {
            const today = new Date();
            let startDate, endDate;

            switch (rangeType) {
                case 'thisWeek':
                    // Start of the week (Standardizing to Monday=1)
                    startDate = new Date(today);
                    // Get day of week (0=Sun, 1=Mon, ... 6=Sat). Subtract 1 to make it 0=Mon, ... 6=Sun
                    const day = (today.getDay() === 0 ? 6 : today.getDay() - 1);
                    startDate.setDate(today.getDate() - day);

                    // End of the week (Sunday of current week)
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;

                case 'lastWeek':
                    // Start of last week (Monday)
                    startDate = new Date(today);
                    const lastDay = (today.getDay() === 0 ? 6 : today.getDay() - 1);
                    // Go back to last week's Monday (current day - offset - 7)
                    startDate.setDate(today.getDate() - lastDay - 7);

                    // End of last week (Sunday)
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;

                case 'thisMonth':
                    // First day of current month
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    // Last day of current month (set to today, not end of month, for current data)
                    endDate = new Date(today);
                    break;

                case 'lastMonth':
                    // First day of last month
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    // Last day of last month
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;

                case 'clear':
                    filterStartDate.value = '';
                    filterEndDate.value = '';
                    return null;

                default:
                    return null;
            }

            // Ensure the time component is zeroed out for consistency
            if (startDate) { startDate.setHours(0, 0, 0, 0); }
            if (endDate) { endDate.setHours(0, 0, 0, 0); }

            return { start: formatDate(startDate), end: formatDate(endDate) };
        }

        // --- Event Listeners for Quick Ranges ---

        quickRangeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const rangeType = button.getAttribute('data-range');
                const dates = getRangeDates(rangeType);

                if (dates) {
                    filterStartDate.value = dates.start;
                    filterEndDate.value = dates.end;
                }
            });
        });

        // --- Initialization ---

        function populateFilters() {
            const nameSelect = document.getElementById('filterName');
            const schoolSelect = document.getElementById('filterSchool');

            // 1. Coordinator Filter
            nameSelect.innerHTML = ''; // Clear existing options
            FILTER_DATA.coordinators.sort().forEach(name => {
                const isSelected = (name === 'All Coordinators') ? 'selected' : '';
                nameSelect.innerHTML += `<option value="${name}" ${isSelected}>${name}</option>`;
            });

            // 2. School Filter
            schoolSelect.innerHTML = ''; // Clear existing options
            FILTER_DATA.schools.sort().forEach(school => {
                const isSelected = (school === 'All Schools') ? 'selected' : '';
                schoolSelect.innerHTML += `<option value="${school}" ${isSelected}>${school}</option>`;
            });
        }

        // --- Filtering and Reporting ---

        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();

            filterButton.textContent = 'Loading...';
            filterButton.disabled = true;
            reportContainer.innerHTML = '';
            showMessage('Fetching data...', 'status-blue');

            const formData = new FormData(filterForm);
            const filters = Object.fromEntries(formData.entries());

            // IMPORTANT: Call the server-side function defined in code.js
            google.script.run
                .withSuccessHandler(renderReports)
                .withFailureHandler(onError)
                .getFilteredData(filters);
        });

        function onError(error) {
            filterButton.textContent = 'Run Report';
            filterButton.disabled = false;
            showMessage('Error: Failed to fetch data. ' + error.message, 'status-red');
            console.error(error);
        }

        function renderReports(data) {
            filterButton.textContent = 'Run Report';
            filterButton.disabled = false;
            statusMessage.style.display = 'none';
            reportContainer.innerHTML = ''; // Clear previous reports

            // Display filters used
            let filterDisplay = `
                <div class="filter-info-box">
                    <p><strong>Filters Applied:</strong> Coordinator: ${data.filterValues.name}, School: ${data.filterValues.school}, Dates: ${data.filterValues.startDate || 'Any'} to ${data.filterValues.endDate || 'Any'}</p>
                </div>
            `;
            reportContainer.innerHTML += filterDisplay;


            // --- Report 1: List of all sessions ---
            reportContainer.innerHTML += `
                <h2 class="report-section-title">1. All Filtered Sessions (${data.report1.length} Total)</h2>
                <div class="table-wrapper">
                    ${data.report1.length > 0 ? renderTable(data.report1, data.report1Headers) : '<p class="filter-info-box">No sessions found for the applied filters.</p>'}
                </div>
            `;

            // --- Report 2: Class Breakdown (Conditional) ---
            if (data.report2 && data.report2.length > 0) {
                 reportContainer.innerHTML += `
                    <h2 class="report-section-title">2. Class-wise Session Breakdown for ${data.filterValues.school}</h2>
                    <div class="class-breakdown-grid">
                        ${renderClassBreakdown(data.report2)}
                    </div>
                `;
            } else if (data.filterValues.school !== 'All Schools') {
                reportContainer.innerHTML += `
                    <p class="filter-info-box">No session data found for the selected school within the date range, or class data is not available on the 'Schools' sheet.</p>
                `;
            } else {
                 reportContainer.innerHTML += `
                    <p class="filter-info-box">Class breakdown report is available only when filtering by a single school.</p>
                `;
            }
        }

        function escapeHtml(str) {
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Helper function to render the main table (Report 1)
        function renderTable(data, headers) {
            let html = '<table class="data-table">';

            // Table Header
            html += '<thead><tr>';
            headers.forEach(header => {
                let displayHeader = header;
                // Clean up long header names for the dashboard view
                if(header === 'Class_Student_Counts') displayHeader = 'Classes & Students';
                if(header === 'Learning Outcomes') displayHeader = 'Outcomes';
                if(header === 'Challenges Faced') displayHeader = 'Challenges';

                html += `<th scope="col">${displayHeader}</th>`;
            });
            html += '</tr></thead>';

            // Table Body
            html += '<tbody>';
            data.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    // Truncate long text fields for better dashboard view
                    let displayCell = escapeHtml(cell.toString());
                    if (displayCell.length > 40) {
                        html += `<td title="${displayCell}">${displayCell.substring(0, 35)}...</td>`;
                    } else {
                        html += `<td>${displayCell}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        // Helper function to render the class breakdown (Report 2)
        function renderClassBreakdown(breakdownData) {
            let html = '';

            breakdownData.forEach(classItem => {
                html += `
                    <div class="class-card">
                        <h3>Class: ${classItem.className}</h3>
                        ${classItem.sessions.length > 0
                            ? `
                            <div>
                                <table class="breakdown-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Module</th>
                                            <th>Attendance</th>
                                            <th>Coordinator</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${classItem.sessions.map(s => `
                                            <tr>
                                                <td>${s.date}</td>
                                                <td>${s.module}</td>
                                                <td>${s.students}</td>
                                                <td>${s.coordinator}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `
                            : '<p class="filter-info-box">No sessions recorded for this class with the current filters.</p>'}
                    </div>
                `;
            });
            return html;
        }

        // Run initialization
        populateFilters();
    </script>
</body>
</html>